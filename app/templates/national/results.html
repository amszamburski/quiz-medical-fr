{% extends "base.html" %}
{% block title %}SFARDLE - RÃ©sultats nationaux{% endblock %}

{% block content %}
{# Compute rank if team is in the leaderboard (available for header badge) #}
{% set ns = namespace(rank=None) %}
{% if leaderboard %}
  {% for td in leaderboard %}
    {% if td.team_name == team %}
      {% set ns.rank = loop.index %}
    {% endif %}
  {% endfor %}
{% endif %}

<!-- Center the whole page content in the viewport -->
<main class="center-viewport">

  <div class="container-xl">
    <div class="card">
      <div class="card-header text-center results-hero results-hero--xl leaderboard-header-gradient" style="color: var(--text-inverse); padding-bottom: var(--space-sm);">
        <div class="brand-header brand-header--stack">
          <img src="{{ url_for('static', filename='images/sfardle-logo.png') }}" alt="SFARDLE" class="brand-logo brand-logo-xxxxl" />
          <h1 class="brand-title-inverse" style="margin-top: var(--space-sm);">Challenge national</h1>
          <div class="brand-meta" style="margin-top: var(--space-xs); margin-bottom: 0;">
            <span class="badge badge-soft">
              Votre Ã©quipe&nbsp;{{ team }}{% if ns.rank is not none %} se classe au rang&nbsp; {{ ns.rank }}{% endif %}
            </span>
          </div>
        </div>
      </div>

      <div class="card-content">
        <!-- KPIs -->
        <div class="kpi-grid">
          <div class="card kpi-card level-{{ final_stats.category | lower | replace(' ', '-') | replace('Ã©','e') | replace('Ã‰','E') }}" style="justify-self:center; width:100%; max-width:520px;">
            <div class="card-content">
              <div class="text-center">
                <div class="score-value">{{ final_stats.total_score }}/{{ final_stats.max_possible }}</div>
                <div class="score-label">Votre performance</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Category badge directly below KPI -->
        <div class="text-center">
          <span class="badge level-badge level-{{ final_stats.category | lower | replace(' ', '-') | replace('Ã©','e') | replace('Ã‰','E') }}">
            {{ final_stats.category }}
          </span>
        </div>
      </div>
    </div>

    {% if leaderboard %}
      <h2 class="podium-title text-center">Podium du jour</h2>
      <!-- PODIUM DU JOUR â€” fully centered section -->
      <section class="podium-section">
        <div class="podium-grid">
          {% for team_data in leaderboard[:3] %}
            {# Derive level class from average score #}
            {% set _avg = team_data.average_score | float %}
            {% set level_class =
              'level-excellent' if _avg >= 4.5 else
              ('level-tres-bien' if _avg >= 3.75 else
              ('level-bien' if _avg >= 3 else
              ('level-moyen' if _avg >= 2 else 'level-insuffisant')))
            %}

            <article class="card podium-card rank-{{ loop.index }}">
              <div class="card-header text-center podium-header">
                <h3 class="mb-0">
                  <span class="podium-medal" aria-hidden="true">
                    {% if loop.index == 1 %}ðŸ¥‡{% elif loop.index == 2 %}ðŸ¥ˆ{% elif loop.index == 3 %}ðŸ¥‰{% endif %}
                  </span>
                  <span class="podium-team">{{ team_data.team_name }}</span>
                </h3>
              </div>
            </article>
          {% endfor %}
        </div>
      </section>
    {% endif %}

    <div class="alert alert-info mt-lg text-center">
      <h3 class="mb-md">Prochain SFARDLE demain !</h3>
    </div>

    <div class="text-center mt-xl" style="display:flex; gap: var(--space-md); justify-content:center; flex-wrap: wrap;">
      <a href="{{ url_for('national.leaderboard') }}" class="btn btn-secondary btn-large">Classement complet</a>
      <a href="{{ url_for('main.index') }}" class="btn btn-primary btn-large">Retour Ã  l'accueil</a>
    </div>
  </div>
</main>
{% endblock %}
