{% extends "base.html" %}
{% block title %}Résultats - Concours Personnel{% endblock %}
{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
  <h1 class="text-center">Tableau de bord personnel</h1>

  <div class="score-display" style="margin-top: var(--space-lg);">
    <div class="score-value">{{ mean_score }}/5</div>
    <div class="score-label">
      Score moyen sur {{ answers_count }} question{% if answers_count != 1 %}s{% endif %} répondue{% if answers_count != 1 %}s{% endif %}
    </div>
  </div>

  {% if topic_stats and topic_stats|length > 0 %}
  <div style="margin-top: var(--space-xl);">
    <h2 class="mb-md">Performance par sujet</h2>
    <div class="mb-md" style="display:flex; gap: var(--space-md); flex-wrap: wrap; align-items:center;">
      <div><strong>Légende:</strong></div>
      <div class="legend-dot level-excellent">Excellent</div>
      <div class="legend-dot level-tres-bien">Très bien</div>
      <div class="legend-dot level-bien">Bien</div>
      <div class="legend-dot level-moyen">Moyen</div>
      <div class="legend-dot level-insuffisant">Insuffisant</div>
    </div>
    <div class="topic-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 320px)); gap: var(--space-md); justify-content: center;">
      {% for stat in topic_stats %}
      <div class="card level-card level-{{ stat.level }}">
        <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:600; line-height:1.2; display:flex; align-items:center; gap:8px;">
            <span class="level-dot level-{{ stat.level }}" aria-hidden="true"></span>
            {{ stat.topic | inline_bold }}
          </div>
          <span class="badge level-badge level-{{ stat.level }}">{{ stat.average_score }}/5</span>
        </div>
        <div class="card-content">
          <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--space-sm);">
            Niveau: {{ stat.category }}
          </div>

          <div style="margin-bottom: var(--space-sm);">
            <div style="display:flex; justify-content:space-between; font-size: var(--font-size-sm); color: var(--text-secondary);">
              <span>Progression</span>
            </div>
            {# Safe guards for zero totals; ring uses --segments #}
            {% set _total = stat.total_available %}
            {% set _ans = stat.answered_count %}
            {% set _segments = _total if _total > 0 else 1 %}
            {% set _active = _ans if _ans <= _segments else _segments %}
            {# values computed directly in SVG for robustness #}

            <!-- SVG ring (dashoffset method for robust rendering) -->
            <div class="level-{{ stat.level }}" role="progressbar" aria-label="Progression" aria-valuemin="0" aria-valuemax="{{ _segments }}" aria-valuenow="{{ _active }}" style="width:96px; height:96px; margin-top: var(--space-sm);">
              <svg width="96" height="96" viewBox="0 0 100 100" style="display:block;">
                <!-- track -->
                <circle cx="50" cy="50" r="42" stroke="var(--border)" stroke-width="10" fill="none" />
                <!-- progress arc -->
                <circle cx="50" cy="50" r="42"
                        stroke="var(--level-color, var(--accent-primary))" stroke-width="10" fill="none" stroke-linecap="round"
                        transform="rotate(-90 50 50)"
                        stroke-dasharray="{{ (2 * 3.1416 * 42) | round(3) }}"
                        stroke-dashoffset="{{ ((2 * 3.1416 * 42) * (1 - ((_active | float) / (_segments | float)))) | round(3) }}" />
                <!-- centered value -->
                <text x="50" y="50" text-anchor="middle" dominant-baseline="middle"
                      style="font-weight:700; font-size:18px; fill: var(--text-primary);">
                  {{ _ans }}/{{ _total }}
                </text>
              </svg>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="text-center" style="display:flex; gap: var(--space-md); justify-content:center; flex-wrap: wrap; margin-top: 30px;">
    <a href="{{ url_for('personal.index') }}" class="btn btn-secondary btn-large" style="margin: 10px;">
      Choisir d'autres sujets
    </a>
    <a href="{{ url_for('main.index') }}" class="btn btn-primary btn-large" style="margin: 10px;">
      Accueil
    </a>
  </div>
</div>
{% endblock %}
