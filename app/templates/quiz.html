{% extends "base.html" %}
{% block title %}SFARDLE - Question{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div class="card">
        <div class="card-header">
            <h1 class="mb-sm">SFARDLE</h1>
            {% if contest_type == 'national' %}
                <p class="mb-0" style="color: var(--text-secondary);">
                    <strong>Équipe:</strong> {{ team }}
                </p>
            {% elif contest_type == 'personal' %}
                <p class="mb-0" style="color: var(--text-secondary);">
                    <strong>Sujet:</strong> {{ topic | inline_bold }}
                </p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="mb-0">Vignette Clinique</h2>
        </div>
        <div class="card-content">
            <p style="line-height: var(--line-height-relaxed);">{{ question.vignette }}</p>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="mb-0">Question</h2>
        </div>
        <div class="card-content">
            <p style="line-height: var(--line-height-relaxed); white-space: pre-line;">{{ question.question }}</p>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="mb-0">Votre réponse</h2>
        </div>
        <div class="card-content">
            <form method="POST" action="{% if contest_type == 'national' %}{{ url_for('national.submit_answer') }}{% else %}{{ url_for('personal.submit_answer') }}{% endif %}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <div class="form-group">
                    <label for="answer" class="sr-only">Votre réponse</label>
                    <textarea name="answer" id="answer" required
                              class="form-control"
                              style="min-height: 120px; resize: vertical;"
                              placeholder="Rédigez votre réponse la plus détaillée possible. Mentionnez le diagnostic, la prise en charge, les traitements recommandés selon les guidelines SFAR..."
                              aria-describedby="answer-help"></textarea>
                    <div id="answer-help" style="font-size: var(--font-size-sm); color: var(--text-muted); margin-top: var(--space-xs);">
                        Plus votre réponse est précise et complète, meilleur sera votre score
                    </div>
                </div>

                <div style="display:flex; gap: var(--space-md); justify-content: space-between; align-items: center; flex-wrap: wrap;">
                  <a href="{{ url_for('main.index') }}" class="btn btn-secondary btn-large">
                    Retourner à l'accueil
                  </a>
                  <button type="submit" class="btn btn-primary btn-large">
                    Valider ma réponse
                  </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function() {
    const form = document.querySelector('form');
    if (!form) return;
    const btn = form.querySelector('button[type="submit"]');
    form.addEventListener('submit', function() {
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Évaluation en cours…';
      }
      // Optional: add a simple overlay
      let overlay = document.getElementById('eval-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'eval-overlay';
        overlay.style.position = 'fixed';
        overlay.style.inset = '0';
        overlay.style.background = 'rgba(255,255,255,0.8)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.zIndex = '9999';
        overlay.innerHTML = '<div style="text-align:center;"><div class="spinner" style="width:48px;height:48px;border:4px solid var(--border);border-top-color: var(--accent-primary);border-radius:50%;margin:0 auto;animation: spin 1s linear infinite;"></div><div style="margin-top:12px;color:var(--text-secondary);">Évaluation de votre réponse…</div></div>';
        document.body.appendChild(overlay);
        const style = document.createElement('style');
        style.textContent = '@keyframes spin { to { transform: rotate(360deg);} }';
        document.head.appendChild(style);
      } else {
        overlay.style.display = 'flex';
      }
    });
  })();
</script>
{% endblock %}
